name: Dependabot Auto-Merge

on:
  pull_request:
    types: [opened, reopened, ready_for_review]

jobs:
  auto-merge:
    # Only run for Dependabot PRs that are not drafts
    if: |
      github.actor == 'dependabot[bot]' &&
      github.event.pull_request.draft == false

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      PR_NUMBER: ${{ github.event.pull_request.number }}

    steps:
      - name: Enable auto-merge
        run: |
          echo "Enabling auto-merge for Dependabot PR #${PR_NUMBER}..."

          # Enable auto-merge with squash
          if gh pr merge $PR_NUMBER --auto --squash; then
            echo "‚úÖ Auto-merge enabled successfully."
            echo "PR will be automatically merged once all required checks pass."
          else
            echo "‚ö†Ô∏è Failed to enable auto-merge."
            echo "Checking PR status..."

            PR_STATE=$(gh pr view $PR_NUMBER --json state,mergeable --jq '{state: .state, mergeable: .mergeable}')
            echo "PR Status: $PR_STATE"

            # Check if already merged (with null safety)
            STATE=$(echo "$PR_STATE" | jq -r '.state // "UNKNOWN"')
            if [ "$STATE" = "MERGED" ]; then
              echo "PR is already merged."
              exit 0
            fi

            # Check if not mergeable (with null safety)
            MERGEABLE=$(echo "$PR_STATE" | jq -r '.mergeable // "UNKNOWN"')
            if [ "$MERGEABLE" = "CONFLICTING" ]; then
              echo "PR has merge conflicts."
              gh pr comment $PR_NUMBER --body "‚ö†Ô∏è Cannot enable auto-merge: This PR has merge conflicts that need to be resolved."
              exit 1
            fi

            exit 1
          fi

      - name: Add comment
        if: success()
        run: |
          # Check if comment already exists to avoid duplicates
          EXISTING_COMMENT=$(gh pr view $PR_NUMBER --json comments --jq '.comments[] | select(.author.login == "github-actions" and (.body | contains("Auto-merge enabled"))) | .id')

          if [ -z "$EXISTING_COMMENT" ]; then
            gh pr comment $PR_NUMBER --body "ü§ñ Auto-merge enabled. This PR will be automatically merged once all required checks pass."
            echo "Comment added to PR #${PR_NUMBER}"
          else
            echo "Comment already exists on PR #${PR_NUMBER}, skipping duplicate"
          fi
