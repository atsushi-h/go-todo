name: Dependabot Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  auto-merge:
    # Only run for Dependabot PRs that are not drafts
    if: |
      github.actor == 'dependabot[bot]' &&
      github.event.pull_request.draft == false

    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Enable auto-merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}

          echo "Enabling auto-merge for Dependabot PR #${PR_NUMBER}..."

          # Enable auto-merge with squash
          if gh pr merge $PR_NUMBER --auto --squash; then
            echo "‚úÖ Auto-merge enabled successfully."
            echo "PR will be automatically merged once all required checks pass."
          else
            echo "‚ö†Ô∏è Failed to enable auto-merge."
            echo "Checking PR status..."

            PR_STATE=$(gh pr view $PR_NUMBER --json state,mergeable --jq '{state: .state, mergeable: .mergeable}')
            echo "PR Status: $PR_STATE"

            # Check if already merged
            if echo "$PR_STATE" | jq -e '.state == "MERGED"' > /dev/null; then
              echo "PR is already merged."
              exit 0
            fi

            # Check if not mergeable
            if echo "$PR_STATE" | jq -e '.mergeable == "CONFLICTING"' > /dev/null; then
              echo "PR has merge conflicts."
              gh pr comment $PR_NUMBER --body "‚ö†Ô∏è Cannot enable auto-merge: This PR has merge conflicts that need to be resolved."
              exit 1
            fi

            exit 1
          fi

      - name: Add comment
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "ü§ñ Auto-merge enabled. This PR will be automatically merged once all required checks pass."
